<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WorkHub</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700&family=DM+Sans:wght@400;500;600&family=Outfit:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&family=IBM+Plex+Sans:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --accent: #f0a843;
  --accent-dim: rgba(240,168,67,0.10);
  --accent-glow: rgba(240,168,67,0.05);
  --bg: #0b0b0e; --bg2: #111115; --bg3: #18181d; --bg4: #1e1e25;
  --border: rgba(255,255,255,0.06); --border-h: rgba(255,255,255,0.11);
  --text: #e8e8f0; --text2: #7a7a8c; --text3: #4a4a5c;
  --red: #e05a5a; --green: #5acc8a; --blue: #5a9ef5; --purple: #a78bfa;
  --radius: 8px; --font: 'Syne', sans-serif; --mono: 'JetBrains Mono', monospace;
}

/* ── Base ── */
html, body { height: 100%; background: var(--bg); color: var(--text); font-family: var(--font); font-size: 14px; overflow: hidden; -webkit-font-smoothing: antialiased; }

/* ── App shell: sidebar + main, both fill full height ── */
.app { display: grid; grid-template-columns: 220px 1fr; height: 100vh; min-height: 0; }

/* ── Sidebar ── */
.sidebar { background: var(--bg2); border-right: 1px solid var(--border); display: flex; flex-direction: column; min-height: 0; overflow: hidden; }
.sb-top { padding: 18px 16px 14px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
.wordmark { font-size: 16px; font-weight: 700; letter-spacing: -0.03em; }
.wordmark span { color: var(--accent); }
.sb-scroll { flex: 1; min-height: 0; overflow-y: auto; padding: 12px 8px; display: flex; flex-direction: column; gap: 2px; }
.sb-label { font-size: 9px; font-family: var(--mono); color: var(--text3); letter-spacing: 0.12em; text-transform: uppercase; padding: 6px 8px 3px; margin-top: 8px; display: block; flex-shrink: 0; }
.sb-label:first-child { margin-top: 0; }

.proj-item { display: flex; align-items: center; gap: 8px; padding: 7px 9px; border-radius: 6px; cursor: pointer; color: var(--text2); font-size: 13px; font-weight: 500; transition: background 0.15s, color 0.15s; user-select: none; flex-shrink: 0; }
.proj-item:hover { background: var(--bg3); color: var(--text); }
.proj-item.active { background: var(--accent-dim); color: var(--accent); }
.proj-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.proj-name { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.proj-badge { font-size: 9px; font-family: var(--mono); padding: 1px 5px; border-radius: 3px; background: var(--bg4); color: var(--text3); border: 1px solid var(--border); flex-shrink: 0; }
.proj-item.active .proj-badge { background: var(--accent-dim); color: var(--accent); border-color: transparent; }
.proj-del { opacity: 0; color: var(--text3); cursor: pointer; display: flex; transition: opacity 0.15s, color 0.15s; flex-shrink: 0; }
.proj-del svg { width: 13px; height: 13px; stroke-width: 2; }
.proj-item:hover .proj-del { opacity: 1; }
.proj-del:hover { color: var(--red) !important; }
.proj-edit { opacity: 0; color: var(--text3); cursor: pointer; display: flex; transition: opacity 0.15s, color 0.15s; flex-shrink: 0; }
.proj-edit svg { width: 13px; height: 13px; stroke-width: 2; }
.proj-item:hover .proj-edit { opacity: 1; }
.proj-edit:hover { color: var(--accent) !important; }

.nav-item { display: flex; align-items: center; gap: 8px; padding: 7px 9px; border-radius: 6px; cursor: pointer; color: var(--text2); font-size: 13px; font-weight: 500; transition: background 0.15s, color 0.15s; user-select: none; flex-shrink: 0; }
.nav-item:hover { background: var(--bg3); color: var(--text); }
.nav-item svg { width: 14px; height: 14px; stroke-width: 1.8; flex-shrink: 0; }
.add-proj { display: flex; align-items: center; gap: 8px; padding: 6px 9px; border-radius: 6px; cursor: pointer; color: var(--text3); font-size: 12px; transition: background 0.15s, color 0.15s; user-select: none; flex-shrink: 0; }
.add-proj:hover { background: var(--bg3); color: var(--text2); }
.add-proj svg { width: 13px; height: 13px; stroke-width: 2; }

.sb-foot { padding: 12px 16px; border-top: 1px solid var(--border); display: flex; align-items: flex-end; justify-content: space-between; flex-shrink: 0; }
.clock { font-family: var(--mono); font-size: 19px; font-weight: 500; letter-spacing: -0.02em; }
.clock-date { font-size: 10px; color: var(--text3); margin-top: 2px; font-family: var(--mono); }
.cog { cursor: pointer; color: var(--text3); padding: 5px; border-radius: 5px; transition: color 0.15s, background 0.15s; display: flex; }
.cog:hover { color: var(--text2); background: var(--bg3); }
.cog svg { width: 15px; height: 15px; stroke-width: 1.8; }

/* ── Main: fills remaining height, no overflow on the wrapper ── */
.main {
  display: flex;
  flex-direction: column;
  min-height: 0;
  overflow: hidden;
  padding: 20px;
  gap: 12px;
}

.page-head { display: flex; align-items: baseline; justify-content: space-between; flex-shrink: 0; }
.page-title { font-size: 19px; font-weight: 700; letter-spacing: -0.03em; }
.page-meta { font-size: 10px; font-family: var(--mono); color: var(--text3); }

/* ── Content area: grows to fill all remaining space ── */
#main-content {
  flex: 1;
  min-height: 0;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* ── Rows: each row shares available height equally ── */
.card-row {
  display: grid;
  gap: 12px;
  flex: 1;
  min-height: 0;
}
.card-row.cols-2 { grid-template-columns: 1fr 1fr; }
.card-row.cols-3 { grid-template-columns: 1fr 1fr 1fr; }

/* ── Card: fills its grid cell, scrollable body ── */
.card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  display: flex;
  flex-direction: column;
  min-height: 0;           /* critical: lets flex children shrink */
  overflow: hidden;
  animation: fadeUp 0.22s ease both;
}
.card:nth-child(1){animation-delay:.04s}.card:nth-child(2){animation-delay:.08s}.card:nth-child(3){animation-delay:.12s}.card:nth-child(4){animation-delay:.16s}

.card-head {
  display: flex; align-items: center; justify-content: space-between;
  padding: 11px 13px; border-bottom: 1px solid var(--border);
  flex-shrink: 0; gap: 8px;
}
.card-label { display: flex; align-items: center; gap: 6px; font-size: 10px; font-family: var(--mono); text-transform: uppercase; letter-spacing: 0.1em; color: var(--text3); flex-shrink: 0; }
.card-label svg { width: 12px; height: 12px; stroke-width: 2; }
.card-acts { display: flex; align-items: center; gap: 5px; flex-wrap: wrap; justify-content: flex-end; }

.cbtn { display: flex; align-items: center; gap: 4px; font-size: 10px; font-family: var(--mono); color: var(--text3); cursor: pointer; padding: 3px 7px; border-radius: 4px; border: 1px solid var(--border); background: transparent; transition: color 0.15s, border-color 0.15s, background 0.15s; white-space: nowrap; }
.cbtn:hover { color: var(--accent); border-color: var(--accent); background: var(--accent-glow); }
.cbtn.ext:hover { color: var(--blue); border-color: var(--blue); background: rgba(90,158,245,0.06); }
.cbtn.tab-on { color: var(--accent); border-color: var(--accent); background: var(--accent-glow); }
.cbtn svg { width: 10px; height: 10px; stroke-width: 2.2; }

/* ── Card body: grows, scrolls, no fixed heights ── */
.card-body {
  flex: 1;
  min-height: 0;
  overflow-y: auto;
  padding: 10px 11px;
  display: flex;
  flex-direction: column;
}

/* Footer rows inside cards (task input, hints) stay at bottom */
.card-footer {
  flex-shrink: 0;
  padding: 8px 11px;
  border-top: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  gap: 6px;
}

/* ── Meetings ── */
.meeting-row {
  display: flex; align-items: center; gap: 10px;
  padding: 9px 10px; border-radius: 6px; border: 1px solid var(--border);
  margin-bottom: 6px; transition: border-color 0.15s, background 0.15s; flex-shrink: 0;
}
.meeting-row:last-child { margin-bottom: 0; }
.meeting-row.now { border-color: rgba(90,158,245,0.3); background: rgba(90,158,245,0.04); }
.meeting-time-block { flex-shrink: 0; text-align: right; min-width: 54px; }
.meeting-time { font-size: 12px; font-family: var(--mono); color: var(--text); font-weight: 500; }
.meeting-end { font-size: 10px; font-family: var(--mono); color: var(--text3); margin-top: 1px; }
.meeting-divider { width: 1px; height: 32px; background: var(--border-h); flex-shrink: 0; }
.meeting-info { flex: 1; min-width: 0; }
.meeting-title { font-size: 13px; font-weight: 500; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.meeting-sub { font-size: 11px; color: var(--text3); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.meeting-now-pill { font-size: 9px; font-family: var(--mono); padding: 1px 6px; border-radius: 3px; background: rgba(90,158,245,0.15); color: var(--blue); border: 1px solid rgba(90,158,245,0.25); flex-shrink: 0; }
.join-btn { display: flex; align-items: center; gap: 5px; font-size: 11px; font-family: var(--mono); font-weight: 500; padding: 5px 10px; border-radius: 5px; border: none; cursor: pointer; background: var(--blue); color: #fff; transition: opacity 0.15s; flex-shrink: 0; white-space: nowrap; }
.join-btn:hover { opacity: 0.85; }
.join-btn svg { width: 11px; height: 11px; stroke-width: 2.2; }
.meeting-del { opacity: 0; cursor: pointer; color: var(--text3); display: flex; flex-shrink: 0; transition: opacity 0.15s, color 0.15s; }
.meeting-del svg { width: 12px; height: 12px; stroke-width: 2; }
.meeting-row:hover .meeting-del { opacity: 1; }
.meeting-del:hover { color: var(--red) !important; }

/* Upcoming list */
.ev-day { font-size: 10px; font-family: var(--mono); color: var(--text3); text-transform: uppercase; letter-spacing: 0.08em; padding: 6px 3px 3px; flex-shrink: 0; }
.ev-day:first-child { padding-top: 0; }
.ev-row { display: flex; gap: 9px; align-items: flex-start; padding: 6px 3px; border-radius: 5px; transition: background 0.12s; flex-shrink: 0; }
.ev-row:hover { background: var(--bg3); }
.ev-time { font-size: 10px; font-family: var(--mono); color: var(--text3); flex-shrink: 0; width: 54px; padding-top: 2px; }
.ev-bar { width: 2px; flex-shrink: 0; border-radius: 2px; align-self: stretch; min-height: 16px; }
.ev-body { flex: 1; min-width: 0; }
.ev-title { font-size: 13px; color: var(--text); }
.ev-sub { font-size: 11px; color: var(--text3); margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.ev-join { display: flex; align-items: center; gap: 4px; font-size: 10px; font-family: var(--mono); color: var(--blue); cursor: pointer; flex-shrink: 0; padding: 2px 6px; border-radius: 4px; border: 1px solid rgba(90,158,245,0.25); transition: background 0.15s; }
.ev-join:hover { background: rgba(90,158,245,0.08); }
.ev-join svg { width: 10px; height: 10px; stroke-width: 2; }
.evdel { opacity: 0; cursor: pointer; color: var(--text3); display: flex; flex-shrink: 0; transition: opacity 0.15s, color 0.15s; }
.evdel svg { width: 12px; height: 12px; stroke-width: 2; }
.ev-row:hover .evdel { opacity: 1; }
.evdel:hover { color: var(--red) !important; }

/* ── Quick Links ── */
.links-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(76px, 1fr)); gap: 7px; align-content: start; }
.link-tile { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; padding: 12px 5px; border-radius: 6px; border: 1px solid var(--border); cursor: pointer; text-align: center; user-select: none; position: relative; transition: border-color 0.15s, background 0.15s; }
.link-tile:hover { border-color: var(--border-h); background: var(--bg3); }
.link-tile svg { width: 17px; height: 17px; stroke-width: 1.7; color: var(--text2); transition: color 0.15s; }
.link-tile:hover svg { color: var(--text); }
.link-tile-name { font-size: 10px; color: var(--text2); font-weight: 500; line-height: 1.2; }
.tile-del { position: absolute; top: 3px; right: 3px; opacity: 0; cursor: pointer; color: var(--text3); display: flex; transition: opacity 0.15s, color 0.15s; }
.tile-del svg { width: 11px; height: 11px; stroke-width: 2; }
.link-tile:hover .tile-del { opacity: 1; }
.tile-del:hover { color: var(--red) !important; }
.add-tile { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; padding: 12px 5px; border-radius: 6px; border: 1px dashed var(--border); cursor: pointer; color: var(--text3); font-size: 10px; transition: border-color 0.15s, color 0.15s; }
.add-tile:hover { border-color: var(--text3); color: var(--text2); }
.add-tile svg { width: 14px; height: 14px; stroke-width: 1.8; }
.folder-tile { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; padding: 12px 5px; border-radius: 6px; border: 1px solid rgba(240,168,67,0.15); background: rgba(240,168,67,0.04); cursor: pointer; text-align: center; user-select: none; position: relative; transition: border-color 0.15s, background 0.15s; }
.folder-tile:hover { border-color: rgba(240,168,67,0.3); background: rgba(240,168,67,0.08); }
.folder-tile svg { width: 17px; height: 17px; stroke-width: 1.7; color: var(--accent); opacity: 0.8; }
.folder-tile-name { font-size: 10px; color: var(--text2); font-weight: 500; line-height: 1.2; }

/* ── Tasks ── */
.task-row { display: flex; align-items: flex-start; gap: 8px; padding: 6px 3px; border-radius: 5px; transition: background 0.12s; flex-shrink: 0; }
.task-row:hover { background: var(--bg3); }
.tcheck { width: 14px; height: 14px; border-radius: 3px; border: 1.5px solid var(--border-h); flex-shrink: 0; cursor: pointer; margin-top: 2px; display: flex; align-items: center; justify-content: center; transition: background 0.15s, border-color 0.15s; }
.tcheck svg { width: 9px; height: 9px; stroke-width: 2.8; color: #000; display: none; }
.tcheck.done { background: var(--green); border-color: var(--green); }
.tcheck.done svg { display: block; }
.tcheck:hover:not(.done) { border-color: var(--green); }
.ttext { font-size: 13px; color: var(--text); flex: 1; line-height: 1.4; }
.ttext.done { color: var(--text3); text-decoration: line-through; }
.tdel { opacity: 0; cursor: pointer; color: var(--text3); display: flex; transition: opacity 0.15s, color 0.15s; flex-shrink: 0; }
.tdel svg { width: 12px; height: 12px; stroke-width: 2; }
.task-row:hover .tdel { opacity: 1; }
.tdel:hover { color: var(--red) !important; }
.task-input-row { display: flex; gap: 7px; }
.tool-hint-row { display: flex; align-items: center; justify-content: space-between; }
.hint-text { font-size: 10px; font-family: var(--mono); color: var(--text3); }

/* ── Notes ── */
.note-row { display: flex; align-items: flex-start; gap: 9px; padding: 8px 7px; border-radius: 6px; border: 1px solid transparent; cursor: pointer; flex-shrink: 0; transition: border-color 0.15s, background 0.15s; }
.note-row:hover { border-color: var(--border-h); background: var(--bg3); }
.note-ico { color: var(--accent); flex-shrink: 0; margin-top: 1px; display: flex; opacity: 0.7; }
.note-ico svg { width: 12px; height: 12px; stroke-width: 2; }
.note-content { flex: 1; min-width: 0; }
.note-t { font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.note-p { font-size: 11px; color: var(--text3); margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.note-d { font-size: 10px; font-family: var(--mono); color: var(--text3); flex-shrink: 0; margin-top: 1px; }
.ndel { opacity: 0; cursor: pointer; color: var(--text3); display: flex; flex-shrink: 0; transition: opacity 0.15s, color 0.15s; margin-top: 1px; }
.ndel svg { width: 12px; height: 12px; stroke-width: 2; }
.note-row:hover .ndel { opacity: 1; }
.ndel:hover { color: var(--red) !important; }

/* ── Empty state ── */
.empty { text-align: center; color: var(--text3); font-size: 11px; font-family: var(--mono); padding: 24px 0; line-height: 1.7; flex: 1; display: flex; align-items: center; justify-content: center; }

/* ── Inputs ── */
input[type="text"], textarea, select { background: var(--bg3); border: 1px solid var(--border); border-radius: 5px; color: var(--text); font-family: var(--font); font-size: 13px; padding: 7px 10px; outline: none; transition: border-color 0.15s; width: 100%; }
input[type="text"]:focus, textarea:focus, select:focus { border-color: var(--accent); }
::placeholder { color: var(--text3); }
input[type="color"] { background: var(--bg3); border: 1px solid var(--border); border-radius: 5px; padding: 3px; height: 30px; width: 60px; cursor: pointer; }
.btn { padding: 7px 14px; border-radius: 5px; border: none; cursor: pointer; font-family: var(--font); font-size: 13px; font-weight: 500; transition: opacity 0.15s; display: inline-flex; align-items: center; gap: 5px; }
.btn:hover { opacity: 0.85; }
.btn-p { background: var(--accent); color: #0b0b0e; }
.btn-g { background: var(--bg3); color: var(--text2); border: 1px solid var(--border); }
.btn svg { width: 12px; height: 12px; stroke-width: 2.2; }

/* Toggle */
.toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 2px 0; }
.toggle-label { font-size: 13px; color: var(--text2); }
.toggle { position: relative; width: 36px; height: 20px; flex-shrink: 0; }
.toggle input { opacity: 0; width: 0; height: 0; position: absolute; }
.toggle-track { position: absolute; inset: 0; background: var(--bg4); border: 1px solid var(--border-h); border-radius: 20px; cursor: pointer; transition: background 0.2s, border-color 0.2s; }
.toggle input:checked + .toggle-track { background: var(--accent); border-color: var(--accent); }
.toggle-thumb { position: absolute; top: 3px; left: 3px; width: 12px; height: 12px; background: var(--text3); border-radius: 50%; transition: transform 0.2s, background 0.2s; pointer-events: none; }
.toggle input:checked ~ .toggle-thumb { transform: translateX(16px); background: #fff; }

/* ── Overlay / Modal ── */
.overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.55); backdrop-filter: blur(6px); display: flex; align-items: center; justify-content: center; z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.18s; }
.overlay.open { opacity: 1; pointer-events: all; }
.modal { background: var(--bg2); border: 1px solid var(--border-h); border-radius: 10px; padding: 22px; transform: translateY(8px); transition: transform 0.18s; }
.overlay.open .modal { transform: translateY(0); }
.m-sm { width: 390px; max-width: 92vw; }
.m-md { width: 460px; max-width: 92vw; }
.m-lg { width: 520px; max-width: 92vw; }
.modal h2 { font-size: 15px; font-weight: 600; margin-bottom: 16px; }
.field { margin-bottom: 11px; }
.lbl { font-size: 10px; font-family: var(--mono); color: var(--text3); text-transform: uppercase; letter-spacing: 0.09em; display: block; margin-bottom: 4px; }
.mrow { display: flex; gap: 8px; justify-content: flex-end; margin-top: 18px; }
.field-row { display: flex; gap: 8px; }
.field-row .field { flex: 1; }

.folder-list { display: flex; flex-direction: column; gap: 5px; margin-top: 4px; }
.folder-entry { display: flex; gap: 7px; align-items: center; }
.folder-entry input { flex: 1; }
.folder-entry-del { cursor: pointer; color: var(--text3); display: flex; transition: color 0.15s; flex-shrink: 0; }
.folder-entry-del svg { width: 14px; height: 14px; stroke-width: 2; }
.folder-entry-del:hover { color: var(--red); }
.add-folder-btn { display: flex; align-items: center; gap: 5px; font-size: 11px; font-family: var(--mono); color: var(--text3); cursor: pointer; margin-top: 6px; padding: 3px 0; transition: color 0.15s; }
.add-folder-btn:hover { color: var(--text2); }
.add-folder-btn svg { width: 12px; height: 12px; stroke-width: 2; }

.icon-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; margin-top: 5px; }
.icon-opt { width: 32px; height: 32px; border-radius: 5px; border: 1px solid var(--border); background: var(--bg3); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: border-color 0.15s, background 0.15s; color: var(--text2); }
.icon-opt svg { width: 14px; height: 14px; stroke-width: 1.8; }
.icon-opt:hover { border-color: var(--border-h); background: var(--bg4); color: var(--text); }
.icon-opt.sel { border-color: var(--accent); background: var(--accent-dim); color: var(--accent); }

.cdots { display: flex; gap: 7px; margin-top: 5px; }
.cdot { width: 20px; height: 20px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: border-color 0.15s, transform 0.15s; }
.cdot:hover { transform: scale(1.15); }
.cdot.sel { border-color: rgba(255,255,255,0.5); }

.note-title-inp { background: transparent; border: none; border-bottom: 1px solid var(--border); border-radius: 0; font-size: 17px; font-weight: 600; color: var(--text); padding: 0 0 10px; margin-bottom: 11px; font-family: var(--font); width: 100%; }
.note-title-inp:focus { outline: none; border-bottom-color: var(--accent); }
textarea.nbody { min-height: 140px; resize: vertical; line-height: 1.65; font-size: 13px; }

.s-section { margin-bottom: 18px; }
.s-section:last-child { margin-bottom: 0; }
.s-title { font-size: 10px; font-family: var(--mono); text-transform: uppercase; letter-spacing: 0.1em; color: var(--text3); margin-bottom: 9px; }
.font-opts { display: flex; flex-direction: column; gap: 4px; }
.font-opt { padding: 8px 10px; border-radius: 5px; border: 1px solid var(--border); cursor: pointer; font-size: 13px; color: var(--text2); transition: border-color 0.15s, background 0.15s, color 0.15s; }
.font-opt:hover { border-color: var(--border-h); background: var(--bg3); color: var(--text); }
.font-opt.sel { border-color: var(--accent); background: var(--accent-dim); color: var(--accent); }
.accent-row { display: flex; align-items: center; gap: 10px; }
.accent-preview { width: 26px; height: 26px; border-radius: 50%; flex-shrink: 0; }

::-webkit-scrollbar { width: 3px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border-h); border-radius: 2px; }
@keyframes fadeUp { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>
<div class="app">

  <aside class="sidebar">
    <div class="sb-top"><div class="wordmark">work<span>hub</span></div></div>
    <div class="sb-scroll">
      <span class="sb-label">Projects</span>
      <div id="proj-list"></div>
      <div class="add-proj" id="add-proj"><i data-lucide="plus"></i> New project</div>
      <span class="sb-label">Tools</span>
      <div class="nav-item" onclick="openKanri()"><i data-lucide="layout-kanban"></i> Kanri</div>
      <div class="nav-item" onclick="openJoplin()"><i data-lucide="notebook"></i> Joplin</div>
    </div>
    <div class="sb-foot">
      <div><div class="clock" id="clock">00:00</div><div class="clock-date" id="cdate"></div></div>
      <div class="cog" onclick="openOv('ov-settings')"><i data-lucide="settings"></i></div>
    </div>
  </aside>

  <main class="main">
    <div class="page-head">
      <div class="page-title" id="ptitle">Select a project</div>
      <div class="page-meta" id="pmeta"></div>
    </div>
    <div id="main-content"></div>
  </main>
</div>

<!-- Project modal -->
<div class="overlay" id="ov-proj">
  <div class="modal m-md">
    <h2 id="proj-h">New Project</h2>
    <div class="field-row">
      <div class="field">
        <label class="lbl">Name</label>
        <input type="text" id="proj-name" placeholder="My Project">
      </div>
      <div class="field" style="flex:0 0 auto">
        <label class="lbl">Color</label>
        <div class="cdots" id="proj-dots">
          <div class="cdot sel" data-c="amber" style="background:#f0a843" onclick="pickColor(this)"></div>
          <div class="cdot" data-c="blue" style="background:#5a9ef5" onclick="pickColor(this)"></div>
          <div class="cdot" data-c="green" style="background:#5acc8a" onclick="pickColor(this)"></div>
          <div class="cdot" data-c="red" style="background:#e05a5a" onclick="pickColor(this)"></div>
          <div class="cdot" data-c="purple" style="background:#a78bfa" onclick="pickColor(this)"></div>
        </div>
      </div>
    </div>
    <div class="field">
      <div class="toggle-row">
        <span class="toggle-label">Work project (enables meetings &amp; calendar)</span>
        <label class="toggle"><input type="checkbox" id="proj-work"><div class="toggle-track"></div><div class="toggle-thumb"></div></label>
      </div>
    </div>
    <div class="field"><label class="lbl">Joplin notebook (optional)</label><input type="text" id="proj-joplin" placeholder="Notebook name"></div>
    <div class="field">
      <label class="lbl">Folders</label>
      <div class="folder-list" id="proj-folder-list"></div>
      <div class="add-folder-btn" onclick="addFolderEntry()"><i data-lucide="plus"></i> Add folder</div>
    </div>
    <div class="mrow">
      <button class="btn btn-g" onclick="closeOv('ov-proj')">Cancel</button>
      <button class="btn btn-p" onclick="saveProject()">Save</button>
    </div>
  </div>
</div>

<!-- Link modal -->
<div class="overlay" id="ov-link">
  <div class="modal m-md">
    <h2>Add Quick Link</h2>
    <div class="field"><label class="lbl">Name</label><input type="text" id="l-name" placeholder="GitHub"></div>
    <div class="field"><label class="lbl">URL or path</label><input type="text" id="l-url" placeholder="https://github.com"></div>
    <div class="field"><label class="lbl">Icon</label><div class="icon-grid" id="icon-grid"></div></div>
    <div class="mrow">
      <button class="btn btn-g" onclick="closeOv('ov-link')">Cancel</button>
      <button class="btn btn-p" onclick="saveLink()">Add</button>
    </div>
  </div>
</div>

<!-- Event modal -->
<div class="overlay" id="ov-event">
  <div class="modal m-sm">
    <h2>Add Event / Meeting</h2>
    <div class="field"><label class="lbl">Title</label><input type="text" id="ev-t" placeholder="Team standup"></div>
    <div class="field"><label class="lbl">Time</label><input type="text" id="ev-w" placeholder="9:00 AM — 9:30 AM"></div>
    <div class="field"><label class="lbl">Join URL (optional)</label><input type="text" id="ev-url" placeholder="https://meet.google.com/..."></div>
    <div class="field"><label class="lbl">Note (optional)</label><input type="text" id="ev-n" placeholder="Location, agenda..."></div>
    <div class="mrow">
      <button class="btn btn-g" onclick="closeOv('ov-event')">Cancel</button>
      <button class="btn btn-p" onclick="saveEvent()">Add</button>
    </div>
  </div>
</div>

<!-- Note modal -->
<div class="overlay" id="ov-note">
  <div class="modal m-lg">
    <input type="text" class="note-title-inp" id="n-title" placeholder="Note title...">
    <textarea class="nbody" id="n-body" placeholder="Write anything..."></textarea>
    <div class="mrow">
      <button class="btn btn-g" onclick="closeOv('ov-note')">Cancel</button>
      <button class="btn btn-p" onclick="saveNote()">Save</button>
    </div>
  </div>
</div>

<!-- Settings -->
<div class="overlay" id="ov-settings">
  <div class="modal m-md">
    <h2>Settings</h2>
    <div class="s-section">
      <div class="s-title">Accent Color</div>
      <div class="accent-row">
        <input type="color" id="acc-pick" value="#f0a843" oninput="setAccent(this.value)">
        <div class="accent-preview" id="acc-prev" style="background:#f0a843"></div>
        <span style="font-size:11px;font-family:var(--mono);color:var(--text3)" id="acc-hex">#f0a843</span>
      </div>
    </div>
    <div class="s-section">
      <div class="s-title">Font</div>
      <div class="font-opts" id="font-opts">
        <div class="font-opt sel" data-f="Syne" style="font-family:'Syne'" onclick="setFont(this)">Syne — geometric</div>
        <div class="font-opt" data-f="Outfit" style="font-family:'Outfit'" onclick="setFont(this)">Outfit — friendly</div>
        <div class="font-opt" data-f="DM Sans" style="font-family:'DM Sans'" onclick="setFont(this)">DM Sans — clean</div>
        <div class="font-opt" data-f="Plus Jakarta Sans" style="font-family:'Plus Jakarta Sans'" onclick="setFont(this)">Plus Jakarta Sans — sharp</div>
        <div class="font-opt" data-f="IBM Plex Sans" style="font-family:'IBM Plex Sans'" onclick="setFont(this)">IBM Plex Sans — technical</div>
      </div>
    </div>
    <div class="s-section">
      <div class="s-title">App Paths</div>
      <div class="field"><label class="lbl">Kanri .exe</label><input type="text" id="kanri-path" placeholder="C:\...\Kanri.exe" oninput="savePaths()"></div>
      <div class="field" style="margin-bottom:0"><label class="lbl">Joplin .exe</label><input type="text" id="joplin-path" placeholder="C:\...\Joplin.exe" oninput="savePaths()"></div>
    </div>
    <div class="mrow"><button class="btn btn-p" onclick="closeOv('ov-settings')">Done</button></div>
  </div>
</div>

<script>
const DOT   = { amber:'#f0a843', blue:'#5a9ef5', green:'#5acc8a', red:'#e05a5a', purple:'#a78bfa' };
const BAR   = ['#f0a843','#5a9ef5','#5acc8a','#a78bfa','#e05a5a'];
const ICONS = ['globe','link','github','figma','code-2','terminal','folder','database','monitor','smartphone','mail','book','youtube','music','image','box','cloud','coffee','settings','send','layers','trello','slack','pen-tool'];

let DB       = { projects:[], settings:{ accent:'#f0a843', font:'Syne', kanriPath:'', joplinPath:'' } };
let active   = null, editNote = null, editProj = null, pickCol = 'amber', pickIcon = 'globe', calView = 'today';

function save(){ localStorage.setItem('hub5', JSON.stringify(DB)); }
function load(){
  try { const d=localStorage.getItem('hub5'); if(d) DB=JSON.parse(d); else seed(); }
  catch(e){ seed(); }
  if(DB.projects.length) active=DB.projects[0].id;
  applyTheme();
}
function seed(){
  const work=np('Work','blue',true);
  work.links=[{id:uid(),icon:'github',name:'GitHub',url:'https://github.com'},{id:uid(),icon:'figma',name:'Figma',url:'https://figma.com'},{id:uid(),icon:'mail',name:'Gmail',url:'https://mail.google.com'}];
  work.tasks=[{id:uid(),text:'Import your .ics calendar file',done:false},{id:uid(),text:'Connect Kanri in settings',done:false}];
  work.events=[
    {id:uid(),title:'Morning standup',time:'9:00 AM',endTime:'9:15 AM',joinUrl:'https://meet.google.com',note:'Daily sync',dayLabel:'Today',isToday:true},
    {id:uid(),title:'Design review',time:'2:00 PM',endTime:'3:00 PM',joinUrl:'https://meet.google.com',note:'Figma handoff',dayLabel:'Today',isToday:true},
    {id:uid(),title:'Sprint planning',time:'10:00 AM',endTime:'11:00 AM',joinUrl:'',note:'',dayLabel:'Tomorrow',isToday:false},
  ];
  work.folders=[{id:uid(),name:'Docs',path:'C:\\Users\\Dev\\Documents\\Work'}];

  const personal=np('Personal','amber',false);
  personal.links=[{id:uid(),icon:'youtube',name:'YouTube',url:'https://youtube.com'},{id:uid(),icon:'coffee',name:'Reddit',url:'https://reddit.com'}];
  personal.tasks=[{id:uid(),text:'Add your personal links',done:false}];
  personal.notes=[{id:uid(),title:'Ideas',body:'Side project brainstorm...',date:ds()}];

  DB.projects=[work,personal]; active=work.id; save();
}
function np(name,color,workMode){ return {id:uid(),name,color,workMode:!!workMode,joplin:'',links:[],tasks:[],notes:[],events:[],folders:[]}; }
function uid(){ return Math.random().toString(36).slice(2,9); }
function ds(){ return new Date().toLocaleDateString('en-US',{month:'short',day:'numeric'}); }
function ga(){ return DB.projects.find(p=>p.id===active); }
function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function ri(){ if(window.lucide) lucide.createIcons(); }

// Theme
function applyTheme(){
  const s=DB.settings;
  document.documentElement.style.setProperty('--accent',s.accent);
  const r=parseInt(s.accent.slice(1,3),16),g=parseInt(s.accent.slice(3,5),16),b=parseInt(s.accent.slice(5,7),16);
  document.documentElement.style.setProperty('--accent-dim',`rgba(${r},${g},${b},0.10)`);
  document.documentElement.style.setProperty('--accent-glow',`rgba(${r},${g},${b},0.05)`);
  document.documentElement.style.setProperty('--font',`'${s.font}', sans-serif`);
  const ap=document.getElementById('acc-pick'); if(ap) ap.value=s.accent;
  const apv=document.getElementById('acc-prev'); if(apv) apv.style.background=s.accent;
  const ah=document.getElementById('acc-hex'); if(ah) ah.textContent=s.accent;
  document.querySelectorAll('.font-opt').forEach(e=>e.classList.toggle('sel',e.dataset.f===s.font));
  const kp=document.getElementById('kanri-path'); if(kp&&s.kanriPath) kp.value=s.kanriPath;
  const jp=document.getElementById('joplin-path'); if(jp&&s.joplinPath) jp.value=s.joplinPath;
}
function setAccent(v){ DB.settings.accent=v; applyTheme(); save(); }
function setFont(el){ DB.settings.font=el.dataset.f; applyTheme(); save(); }
function savePaths(){ DB.settings.kanriPath=document.getElementById('kanri-path').value; DB.settings.joplinPath=document.getElementById('joplin-path').value; save(); }

// Render
function render(){ renderSidebar(); renderMain(); ri(); }

function renderSidebar(){
  const list=document.getElementById('proj-list'); list.innerHTML='';
  DB.projects.forEach(p=>{
    const el=document.createElement('div');
    el.className='proj-item'+(p.id===active?' active':'');
    el.dataset.id=p.id;
    el.innerHTML=`<div class="proj-dot" style="background:${DOT[p.color]||'var(--accent)'}"></div><div class="proj-name">${esc(p.name)}</div>${p.workMode?`<span class="proj-badge">work</span>`:''}<div class="proj-edit" data-action="edit"><i data-lucide="pencil"></i></div><div class="proj-del" data-action="del"><i data-lucide="x"></i></div>`;
    el.addEventListener('click', e=>{
      const action=e.target.closest('[data-action]')?.dataset?.action;
      if(action==='del'){ e.stopPropagation(); delProj(p.id); }
      else if(action==='edit'){ e.stopPropagation(); editProject(p.id); }
      else { active=p.id; calView='today'; render(); }
    });
    list.appendChild(el);
  });
}

function renderMain(){
  const p=ga();
  const mc=document.getElementById('main-content');
  mc.innerHTML='';
  if(!p){ document.getElementById('ptitle').textContent='Select a project'; return; }
  document.getElementById('ptitle').innerHTML=`${esc(p.name)} <span style="color:${DOT[p.color]};margin-left:2px">·</span>`;
  const done=(p.tasks||[]).filter(t=>t.done).length, tot=(p.tasks||[]).length;
  document.getElementById('pmeta').textContent=tot?`${done}/${tot} tasks`:'';

  if(p.workMode){
    // Row 1: Meetings | Links
    const r1=document.createElement('div'); r1.className='card-row cols-2'; mc.appendChild(r1);
    const s1=document.createElement('div'); r1.appendChild(s1);
    const s2=document.createElement('div'); r1.appendChild(s2);
    buildMeetingsCard(p, s1);
    buildLinksCard(p, s2);
    // Row 2: Tasks | Notes
    const r2=document.createElement('div'); r2.className='card-row cols-2'; mc.appendChild(r2);
    const s3=document.createElement('div'); r2.appendChild(s3);
    const s4=document.createElement('div'); r2.appendChild(s4);
    buildTasksCard(p, s3);
    buildNotesCard(p, s4);
  } else {
    // Row 1: Links | Tasks
    const r1=document.createElement('div'); r1.className='card-row cols-2'; mc.appendChild(r1);
    const s1=document.createElement('div'); r1.appendChild(s1);
    const s2=document.createElement('div'); r1.appendChild(s2);
    buildLinksCard(p, s1);
    buildTasksCard(p, s2);
    // Row 2: Notes full-width
    const r2=document.createElement('div'); r2.className='card-row'; mc.appendChild(r2);
    buildNotesCard(p, r2);
  }
}

// ── Card builders ─────────────────────────────────────────────────────────

function buildMeetingsCard(p, slot){
  const card=document.createElement('div'); card.className='card'; slot.appendChild(card);
  // Head
  const head=document.createElement('div'); head.className='card-head'; card.appendChild(head);
  head.innerHTML=`<div class="card-label"><i data-lucide="video"></i> Meetings</div>
    <div class="card-acts">
      <button class="cbtn ${calView==='today'?'tab-on':''}" onclick="setCalView('today')">Today</button>
      <button class="cbtn ${calView==='upcoming'?'tab-on':''}" onclick="setCalView('upcoming')">Upcoming</button>
      <button class="cbtn" onclick="triggerICS()"><i data-lucide="upload"></i> .ics</button>
      <button class="cbtn" onclick="openEventModal()"><i data-lucide="plus"></i></button>
    </div>`;
  // Body
  const body=document.createElement('div'); body.className='card-body'; card.appendChild(body);
  // ICS input
  const icsInp=document.createElement('input'); icsInp.type='file'; icsInp.id='ics-inp'; icsInp.accept='.ics'; icsInp.style.display='none'; icsInp.onchange=importICS; card.appendChild(icsInp);

  const todayEvs=(p.events||[]).filter(e=>e.isToday||e.dayLabel==='Today');
  const allEvs=p.events||[];

  if(calView==='today'){
    if(!todayEvs.length){
      const em=document.createElement('div'); em.className='empty'; em.textContent='No meetings today — import .ics or add manually'; body.appendChild(em);
    } else {
      todayEvs.forEach(ev=>{
        const nowMark=isNowBetween(ev.time,ev.endTime);
        const el=document.createElement('div'); el.className='meeting-row'+(nowMark?' now':'');
        el.innerHTML=`<div class="meeting-time-block"><div class="meeting-time">${esc(ev.time||'')}</div>${ev.endTime?`<div class="meeting-end">${esc(ev.endTime)}</div>`:''}</div><div class="meeting-divider"></div><div class="meeting-info"><div class="meeting-title">${esc(ev.title)}</div>${ev.note?`<div class="meeting-sub">${esc(ev.note)}</div>`:''}</div>${nowMark?`<div class="meeting-now-pill">Now</div>`:''} ${ev.joinUrl?`<button class="join-btn" onclick="openURL('${esc(ev.joinUrl)}')"><i data-lucide="video"></i> Join</button>`:''}<div class="meeting-del" onclick="delEvent('${ev.id}')"><i data-lucide="x"></i></div>`;
        body.appendChild(el);
      });
    }
  } else {
    if(!allEvs.length){
      const em=document.createElement('div'); em.className='empty'; em.textContent='No upcoming events'; body.appendChild(em);
    } else {
      const groups={};
      allEvs.forEach(ev=>{ const k=ev.dayLabel||'Later'; if(!groups[k]) groups[k]=[]; groups[k].push(ev); });
      let bi=0;
      Object.entries(groups).forEach(([day,evs])=>{
        const lbl=document.createElement('div'); lbl.className='ev-day'; lbl.textContent=day; body.appendChild(lbl);
        evs.forEach(ev=>{
          const el=document.createElement('div'); el.className='ev-row';
          el.innerHTML=`<div class="ev-time">${esc(ev.time||'')}</div><div class="ev-bar" style="background:${BAR[bi++%BAR.length]}"></div><div class="ev-body"><div class="ev-title">${esc(ev.title)}</div>${ev.note?`<div class="ev-sub">${esc(ev.note)}</div>`:''}</div>${ev.joinUrl?`<div class="ev-join" onclick="openURL('${esc(ev.joinUrl)}')"><i data-lucide="video"></i> Join</div>`:''}<div class="evdel" onclick="delEvent('${ev.id}')"><i data-lucide="x"></i></div>`;
          body.appendChild(el);
        });
      });
    }
  }
}

function buildLinksCard(p, slot){
  const card=document.createElement('div'); card.className='card'; slot.appendChild(card);
  card.innerHTML=`<div class="card-head"><div class="card-label"><i data-lucide="zap"></i> Quick Links</div><div class="card-acts"><button class="cbtn" onclick="openLinkModal()"><i data-lucide="plus"></i> Add</button></div></div>`;
  const body=document.createElement('div'); body.className='card-body'; card.appendChild(body);
  const grid=document.createElement('div'); grid.className='links-grid'; body.appendChild(grid);

  (p.links||[]).forEach(l=>{
    const el=document.createElement('div'); el.className='link-tile';
    el.innerHTML=`<div class="tile-del" onclick="event.stopPropagation();delLink('${l.id}')"><i data-lucide="x"></i></div><i data-lucide="${l.icon||'link'}"></i><div class="link-tile-name">${esc(l.name)}</div>`;
    el.onclick=()=>openURL(l.url); grid.appendChild(el);
  });
  (p.folders||[]).forEach(f=>{
    const el=document.createElement('div'); el.className='folder-tile';
    el.innerHTML=`<div class="tile-del" onclick="event.stopPropagation();delFolder('${f.id}')"><i data-lucide="x"></i></div><i data-lucide="folder-open"></i><div class="folder-tile-name">${esc(f.name)}</div>`;
    el.onclick=()=>openFolder(f.path); grid.appendChild(el);
  });
  const add=document.createElement('div'); add.className='add-tile';
  add.innerHTML='<i data-lucide="plus"></i><span>Add</span>'; add.onclick=()=>openLinkModal(); grid.appendChild(add);
}

function buildTasksCard(p, slot){
  const tasks=p.tasks||[];
  const done=tasks.filter(t=>t.done).length;
  const card=document.createElement('div'); card.className='card'; slot.appendChild(card);
  card.innerHTML=`<div class="card-head"><div class="card-label"><i data-lucide="check-square"></i> Tasks</div><div class="card-acts"><span style="font-size:10px;font-family:var(--mono);color:var(--text3)">${tasks.length?`${done} / ${tasks.length}`:''}</span></div></div>`;
  const body=document.createElement('div'); body.className='card-body'; card.appendChild(body);

  if(!tasks.length){ const em=document.createElement('div'); em.className='empty'; em.textContent='No tasks yet'; body.appendChild(em); }
  tasks.forEach(t=>{
    const el=document.createElement('div'); el.className='task-row';
    el.innerHTML=`<div class="tcheck${t.done?' done':''}" onclick="toggleTask('${t.id}')"><i data-lucide="check"></i></div><div class="ttext${t.done?' done':''}">${esc(t.text)}</div><div class="tdel" onclick="delTask('${t.id}')"><i data-lucide="x"></i></div>`;
    body.appendChild(el);
  });

  const footer=document.createElement('div'); footer.className='card-footer'; card.appendChild(footer);
  const inputRow=document.createElement('div'); inputRow.className='task-input-row';
  inputRow.innerHTML=`<input type="text" id="tinp" placeholder="Add a task…" style="flex:1"><button class="btn btn-p" onclick="addTask()" style="padding:6px 11px"><i data-lucide="plus"></i></button>`;
  footer.appendChild(inputRow);
  const hintRow=document.createElement('div'); hintRow.className='tool-hint-row';
  hintRow.innerHTML=`<span class="hint-text">Advanced tasks in Kanri</span><button class="cbtn ext" onclick="openKanri()"><i data-lucide="external-link"></i> Open</button>`;
  footer.appendChild(hintRow);
  setTimeout(()=>{ const i=document.getElementById('tinp'); if(i) i.addEventListener('keydown',e=>{ if(e.key==='Enter') addTask(); }); },0);
}

function buildNotesCard(p, slot){
  const card=document.createElement('div'); card.className='card'; slot.appendChild(card);
  card.innerHTML=`<div class="card-head"><div class="card-label"><i data-lucide="file-text"></i> Notes</div><div class="card-acts"><button class="cbtn ext" onclick="openJoplin()"><i data-lucide="external-link"></i> Joplin</button><button class="cbtn" onclick="openNoteEditor(null)"><i data-lucide="plus"></i> New</button></div></div>`;
  const body=document.createElement('div'); body.className='card-body'; card.appendChild(body);
  const notes=p.notes||[];
  if(!notes.length){ const em=document.createElement('div'); em.className='empty'; em.textContent='No notes yet'; body.appendChild(em); return; }
  [...notes].reverse().forEach(n=>{
    const el=document.createElement('div'); el.className='note-row';
    el.innerHTML=`<div class="note-ico"><i data-lucide="file-text"></i></div><div class="note-content"><div class="note-t">${esc(n.title||'Untitled')}</div><div class="note-p">${esc((n.body||'').slice(0,55))}</div></div><div class="note-d">${n.date||''}</div><div class="ndel" onclick="event.stopPropagation();delNote('${n.id}')"><i data-lucide="x"></i></div>`;
    el.onclick=()=>openNoteEditor(n.id); body.appendChild(el);
  });
}

// ── Actions ───────────────────────────────────────────────────────────────
function openURL(url){ if(!url) return; if(window.require){ try{ window.require('electron').shell.openExternal(url); return; }catch(e){} } window.open(url,'_blank'); }
function openFolder(p){ if(!p) return; if(window.require){ try{ window.require('electron').shell.openPath(p); return; }catch(e){} } window.open('file://'+p,'_blank'); }
function openKanri(){ const path=DB.settings.kanriPath; if(!path){ openOv('ov-settings'); return; } openURL(path); }
function openJoplin(){ const p=ga(), nb=p?.joplin?`joplin://x-callback-url/openNote?notebook=${encodeURIComponent(p.joplin)}`:'joplin://'; openURL(nb); }
function setCalView(v){ calView=v; render(); }
function toggleTask(id){ const p=ga(); if(!p) return; const t=p.tasks.find(t=>t.id===id); if(t) t.done=!t.done; save(); render(); }
function addTask(){ const i=document.getElementById('tinp'),txt=i?.value.trim(); if(!txt) return; const p=ga(); if(!p) return; p.tasks.push({id:uid(),text:txt,done:false}); save(); render(); }
function delTask(id){ const p=ga(); if(!p) return; p.tasks=p.tasks.filter(t=>t.id!==id); save(); render(); }
function delLink(id){ const p=ga(); if(!p) return; p.links=p.links.filter(l=>l.id!==id); save(); render(); }
function delFolder(id){ const p=ga(); if(!p) return; p.folders=(p.folders||[]).filter(f=>f.id!==id); save(); render(); }
function delEvent(id){ const p=ga(); if(!p) return; p.events=p.events.filter(e=>e.id!==id); save(); render(); }
function delNote(id){ const p=ga(); if(!p) return; p.notes=p.notes.filter(n=>n.id!==id); save(); render(); }
function editProject(id){ const p=DB.projects.find(p=>p.id===id); if(!p) return; editProj=id; document.getElementById('proj-name').value=p.name; document.getElementById('proj-joplin').value=p.joplin||''; document.getElementById('proj-work').checked=!!p.workMode; document.getElementById('proj-h').textContent='Edit Project'; document.getElementById('proj-folder-list').innerHTML=''; pickCol=p.color||'amber'; document.querySelectorAll('#proj-dots .cdot').forEach(d=>d.classList.toggle('sel',d.dataset.c===pickCol)); (p.folders||[]).forEach(f=>addFolderEntry(f.name,f.path)); openOv('ov-proj'); }
function delProj(id){ if(!confirm('Delete this project?')) return; DB.projects=DB.projects.filter(p=>p.id!==id); if(active===id) active=DB.projects[0]?.id||null; save(); render(); }

// ICS
function triggerICS(){ document.getElementById('ics-inp')?.click(); }
function importICS(e){
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=ev=>{ const evs=parseICS(ev.target.result); const p=ga(); if(!p) return; evs.forEach(ev=>p.events.push(ev)); save(); render(); e.target.value=''; };
  reader.readAsText(file);
}
function parseICS(text){
  const out=[],now=new Date(),soon=new Date(now.getTime()+60*24*60*60*1000);
  text.split('BEGIN:VEVENT').slice(1).forEach(block=>{
    const get=k=>{ const m=block.match(new RegExp(`${k}[^:]*:([^\r\n]+)`)); return m?m[1].trim():''; };
    const summary=get('SUMMARY'),dtstart=get('DTSTART'),dtend=get('DTEND'),location=get('LOCATION'),desc=get('DESCRIPTION'),urlF=get('^URL');
    if(!summary||!dtstart) return;
    const startDate=icsDate(dtstart); if(!startDate||startDate<now||startDate>soon) return;
    const endDate=dtend?icsDate(dtend):null;
    const dl=dayLabel(startDate),isToday=dl==='Today';
    const joinUrl=urlF||extractURL(desc)||extractURL(location)||'';
    out.push({id:uid(),title:summary,dayLabel:dl,isToday,time:fmtTime(startDate,dtstart),endTime:endDate?fmtTime(endDate,dtend):'',joinUrl,note:location||''});
  });
  return out;
}
function extractURL(s){ if(!s) return ''; const m=s.match(/https?:\/\/[^\s<>"\\]+/); return m?m[0]:''; }
function icsDate(s){ const c=s.replace(/[TZ]/g,''); if(c.length<8) return null; return new Date(`${c.slice(0,4)}-${c.slice(4,6)}-${c.slice(6,8)}T${c.slice(8,10)||'00'}:${c.slice(10,12)||'00'}:00`); }
function dayLabel(d){ const now=new Date(),today=new Date(now.getFullYear(),now.getMonth(),now.getDate()),day=new Date(d.getFullYear(),d.getMonth(),d.getDate()),diff=Math.round((day-today)/86400000); if(diff===0) return 'Today'; if(diff===1) return 'Tomorrow'; if(diff<7) return d.toLocaleDateString('en-US',{weekday:'long'}); return d.toLocaleDateString('en-US',{month:'short',day:'numeric'}); }
function fmtTime(d,raw){ if(!raw||raw.length<=8) return 'All day'; return d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'}); }
function isNowBetween(s,e){ if(!s) return false; try{ const parse=str=>{ const m=str.match(/(\d+):(\d+)\s*(AM|PM)?/i); if(!m) return null; let h=parseInt(m[1]),mn=parseInt(m[2]); const ap=(m[3]||'').toUpperCase(); if(ap==='PM'&&h!==12) h+=12; if(ap==='AM'&&h===12) h=0; return h*60+mn; }; const now=new Date(),nm=now.getHours()*60+now.getMinutes(),st=parse(s),en=e?parse(e):st+60; return st!==null&&nm>=st&&nm<=(en||st+60); }catch(e){ return false; } }

// Overlays
function openOv(id){ document.getElementById(id).classList.add('open'); ri(); }
function closeOv(id){ document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.overlay').forEach(el=>el.addEventListener('click',e=>{ if(e.target===el) el.classList.remove('open'); }));
document.addEventListener('keydown',e=>{ if(e.key==='Escape') document.querySelectorAll('.overlay.open').forEach(el=>el.classList.remove('open')); });

// Project modal
function pickColor(el){ document.querySelectorAll('#proj-dots .cdot').forEach(d=>d.classList.remove('sel')); el.classList.add('sel'); pickCol=el.dataset.c; }
function addFolderEntry(nv,pv){
  const list=document.getElementById('proj-folder-list');
  const row=document.createElement('div'); row.className='folder-entry';
  row.innerHTML=`<input type="text" placeholder="Name" value="${esc(nv||'')}" style="flex:0 0 100px"><input type="text" placeholder="C:\\path\\to\\folder" value="${esc(pv||'')}"><div class="folder-entry-del" onclick="this.parentElement.remove()"><i data-lucide="x"></i></div>`;
  list.appendChild(row); ri();
}
document.getElementById('add-proj').onclick=()=>{
  editProj=null; document.getElementById('proj-name').value=''; document.getElementById('proj-joplin').value='';
  document.getElementById('proj-work').checked=false; document.getElementById('proj-h').textContent='New Project';
  document.getElementById('proj-folder-list').innerHTML=''; pickCol='amber';
  document.querySelectorAll('#proj-dots .cdot').forEach(d=>d.classList.toggle('sel',d.dataset.c==='amber'));
  openOv('ov-proj');
};
function saveProject(){
  const name=document.getElementById('proj-name').value.trim(); if(!name) return;
  const joplin=document.getElementById('proj-joplin').value.trim();
  const workMode=document.getElementById('proj-work').checked;
  const folders=[];
  document.querySelectorAll('#proj-folder-list .folder-entry').forEach(row=>{
    const ins=row.querySelectorAll('input');
    const fn=(ins[0]?.value||'').trim(),fp=(ins[1]?.value||'').trim();
    if(fp) folders.push({id:uid(),name:fn||fp,path:fp});
  });
  if(editProj){ const p=DB.projects.find(p=>p.id===editProj); if(p){p.name=name;p.color=pickCol;p.workMode=workMode;p.joplin=joplin;p.folders=folders;} }
  else{ const p=np(name,pickCol,workMode); p.joplin=joplin; p.folders=folders; DB.projects.push(p); active=p.id; }
  save(); closeOv('ov-proj'); render();
}

// Link modal
function buildIconGrid(){ const g=document.getElementById('icon-grid'); g.innerHTML=''; ICONS.forEach(name=>{ const el=document.createElement('div'); el.className='icon-opt'+(name===pickIcon?' sel':''); el.dataset.icon=name; el.innerHTML=`<i data-lucide="${name}"></i>`; el.onclick=()=>{ document.querySelectorAll('.icon-opt').forEach(e=>e.classList.remove('sel')); el.classList.add('sel'); pickIcon=name; ri(); }; g.appendChild(el); }); }
function openLinkModal(){ document.getElementById('l-name').value=''; document.getElementById('l-url').value=''; pickIcon='globe'; buildIconGrid(); openOv('ov-link'); }
function saveLink(){ const name=document.getElementById('l-name').value.trim(),url=document.getElementById('l-url').value.trim(); if(!name||!url) return; const p=ga(); if(!p) return; p.links.push({id:uid(),icon:pickIcon,name,url}); save(); closeOv('ov-link'); render(); }

// Event modal
function openEventModal(){ ['ev-t','ev-w','ev-url','ev-n'].forEach(id=>document.getElementById(id).value=''); openOv('ov-event'); }
function saveEvent(){
  const title=document.getElementById('ev-t').value.trim(); if(!title) return;
  const timeStr=document.getElementById('ev-w').value.trim();
  const joinUrl=document.getElementById('ev-url').value.trim();
  const note=document.getElementById('ev-n').value.trim();
  const p=ga(); if(!p) return;
  const parts=timeStr.split(/[-–—]+/).map(s=>s.trim());
  p.events.push({id:uid(),title,dayLabel:'Today',isToday:true,time:parts[0]||'',endTime:parts[1]||'',joinUrl,note});
  save(); closeOv('ov-event'); render();
}

// Note modal
function openNoteEditor(id){ editNote=id; if(id){ const n=ga()?.notes.find(n=>n.id===id); if(n){document.getElementById('n-title').value=n.title||''; document.getElementById('n-body').value=n.body||'';} } else{ document.getElementById('n-title').value=''; document.getElementById('n-body').value=''; } openOv('ov-note'); setTimeout(()=>document.getElementById('n-title').focus(),80); }
function saveNote(){ const title=document.getElementById('n-title').value.trim(),body=document.getElementById('n-body').value.trim(); if(!title&&!body){ closeOv('ov-note'); return; } const p=ga(); if(!p) return; if(editNote){ const n=p.notes.find(n=>n.id===editNote); if(n){n.title=title||'Untitled';n.body=body;n.date=ds();} } else{ p.notes.push({id:uid(),title:title||'Untitled',body,date:ds()}); } save(); closeOv('ov-note'); render(); }

// Clock
function tick(){ const now=new Date(); document.getElementById('clock').textContent=now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false}); document.getElementById('cdate').textContent=now.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'}); }

load(); render(); tick(); setInterval(tick,15000);
</script>
</body>
</html>
